<!DOCTYPE html>
<head>
    <link rel="stylesheet" href="/css/view.css" type="text/css">
</head>
<html> 
    <div class="sidebar">
        <div class="sidetitle">
            <h2>File Explorer:</h2>
        </div>
        <div class="sidenav">
            {{ template "node" .SideBar }}
        </div>
        
    </div>
    <div class="main">{{ .FileContent }}</div>
</html>

<!-- Context menu displayed when right clicking on sidebar items  -->
<ul class="sidebar-context-menu" id="sideContextMenu">
    <li onclick="alert('Option 1 selected')">Restrict Access</li>
</ul>

<html>
  <form action="/settings/permissions/deny_entry" method="post" style="z-index: 1001; position: absolute;">
    First Name: <input type="text" name="first_name" placeholder="Willy"/><br/>
    Last Name: <input type="text" name="last_name" placeholder="Warmwood"/><br/>
    Email: <input type="email" name="email" placeholder="willy.warwood@gmail.com"/><br/>
    <input type="submit" value="Submit"/>
  </form>
</html>

{{ define "node" }}
    <ul class="tree">
        {{ range .Children }}
            {{ if .IsDir }}
            <li class="li-folder">
                <details id="/{{ .FullPath }}-D">
                    <summary>&#128193 {{ .Name }}</summary>
                    <div style="position: relative; display: block;">
                        <div class="folder-line"></div>
                        {{ template "node" . }}
                    </div>
                </details>
            </li>
            {{ else }}
            <li class="li-file">
                <span class="file"><a href="/{{ .FullPath }}" id="/{{ .FullPath }}-A">{{ .Name }}</a></span>
            </li>
            {{ end }}
        {{ end }}
    </ul>
{{ end }}


<script>
    document.addEventListener("DOMContentLoaded", function () {
        const sidebar_details = document.querySelectorAll(".sidebar details"); // sidebar folders - list functionality
        const sidebar_summarys = document.querySelectorAll(".sidebar summary"); // sidebar folders - singular object functionality
        const sidebar_links = document.querySelectorAll(".sidebar a"); // sidebar files
        const contextMenu = document.getElementById("sideContextMenu");

        // Restore <details> state from memory, opening the sidebar items
        sidebar_details.forEach(details => {
            const key = `details-${details.id}`;
            details.open = localStorage.getItem(key) === "open";

            details.addEventListener("toggle", () => 
                details.open ? localStorage.setItem(key, "open") : localStorage.removeItem(key)
            );
        });


        // Restore last clicked link in the sidebar and expand its parent <details> if necessary
        const lastClickedElement = document.getElementById(localStorage.getItem("lastClickedLink"));
        if (lastClickedElement) {
            lastClickedElement.classList.add("highlighted");
            openParentDetails(lastClickedElement);
        }

        function openParentDetails(element) {
            const parentDetails = element.closest("details");
            if (parentDetails) {
                parentDetails.open = true;
                openParentDetails(parentDetails.parentElement); // Recursively open further up
            }
        }

        function ActionSideBarLink(linkId) {
            const sideBarLink = document.getElementById(linkId);
            sidebar_links.forEach(l => l.classList.remove("highlighted"));
            sideBarLink.classList.add("highlighted");
            localStorage.setItem("lastClickedLink", sideBarLink.id);
            openParentDetails(sideBarLink);
        }


        function actionSidebarContextMenu(event){
            event.preventDefault();
            const itemName = event.target.getAttribute("data-item");

            contextMenu.style.display = "block";
            contextMenu.style.left = `calc(${event.pageX}px - 0px)`;
            contextMenu.style.top = `calc(${event.pageY}px - 18px)`;
        }

        sidebar_summarys.forEach(summary => {
            summary.addEventListener("contextmenu", (event) => {
                actionSidebarContextMenu(event)
            })
        })

        // Handle link clicks in the sidebar
        sidebar_links.forEach(link => {
            link.addEventListener("click", function () {
                ActionSideBarLink(link.id)
            });
            link.addEventListener("contextmenu", (event) => {
                actionSidebarContextMenu(event)
            })
        });

        document.addEventListener("click", () => {
            contextMenu.style.display = "none";
        });

        // Handle main screen links, attempt to translate broken relative links to absolute links
        document.querySelectorAll(".main a").forEach(link => {
            link.addEventListener("click", event => {
                event.preventDefault();

                try {
                    let href = link.getAttribute("href").replaceAll("%20", " ").replaceAll("../", "");
                    ActionSideBarLink(`/${href}-A`);
                } catch (error) {
                    console.error(error.message);
                }

                const tryLoad = href => fetch(href, { method: "HEAD" })
                    .then(res => res.ok ? (location.href = href) : Promise.reject());

                tryLoad(link.href).catch(() => tryLoad("/" + link.getAttribute("href").replace(/^\/+/, "")));
            });
        });
    });
</script>
